# راهنمای پیکربندی سیستم پیامک (ملی‌پیامک)

## مقدمه

افزونه Tabesh از سرویس **الگومحور (Pattern/Template)** ملی‌پیامک برای ارسال پیامک‌های وضعیت سفارش استفاده می‌کند. این سرویس امکان ارسال پیامک با الگوهای از پیش تعریف‌شده را فراهم می‌کند.

## متد مورد استفاده

این افزونه از متد **`SendByBaseNumber2`** از طریق **SOAP API** ملی‌پیامک استفاده می‌کند.

### مستندات رسمی

- **مستندات API:** [https://github.com/melipayamak](https://github.com/melipayamak)
- **پنل ملی‌پیامک:** [https://panel.melipayamak.com](https://panel.melipayamak.com)

## مراحل راه‌اندازی

### 1. ایجاد الگوی پیامک در پنل ملی‌پیامک

1. وارد پنل ملی‌پیامک شوید
2. به بخش **الگوهای پیامک** بروید
3. یک الگوی جدید ایجاد کنید
4. متن الگو را با متغیرهای مورد نیاز وارد کنید
5. **کد عددی الگو (bodyId)** را یادداشت کنید

### 2. ساختار متغیرهای الگو

الگوی شما در پنل ملی‌پیامک باید شامل **4 متغیر به ترتیب زیر** باشد:

```
متغیر 1: شماره سفارش (مثال: TB-00001)
متغیر 2: نام مشتری
متغیر 3: وضعیت سفارش (به فارسی)
متغیر 4: تاریخ (فرمت: 1402/12/15)
```

### 3. نمونه الگو

```
سفارش {1} برای {2} به وضعیت {3} تغییر کرد.
تاریخ: {4}
```

یا:

```
مشتری گرامی {2}
سفارش شما با شماره {1} به وضعیت {3} تغییر یافت.
{4}
```

### 4. تنظیمات در پنل مدیریت وردپرس

1. به **تنظیمات Tabesh** > **تب پیامک** بروید
2. **فعال‌سازی سیستم پیامک** را تیک بزنید
3. **نام کاربری** و **رمز عبور** پنل ملی‌پیامک را وارد کنید
4. با دکمه **بررسی اتصال** صحت تنظیمات را بررسی کنید
5. برای هر **وضعیت سفارش** که می‌خواهید پیامک ارسال شود:
   - تیک **فعال** را بزنید
   - **کد الگو (bodyId)** را وارد کنید

### 5. نکات مهم

⚠️ **کد الگو (bodyId) باید عدد خالص باشد:**
- ✅ صحیح: `12345`
- ❌ غلط: `pattern-12345` یا `الگو-۱۲۳۴۵`

⚠️ **ترتیب متغیرها مهم است:**
- متغیرها باید دقیقاً به ترتیب مشخص شده (شماره سفارش، نام، وضعیت، تاریخ) در الگو قرار گیرند

⚠️ **تعداد متغیرها باید 4 عدد باشد:**
- اگر الگوی شما کمتر یا بیشتر از 4 متغیر دارد، ارسال پیامک با خطا مواجه می‌شود

## رفع مشکلات رایج

### خطای "کد الگو باید عددی باشد"

**علت:** کد الگو شامل حروف یا کاراکترهای غیرعددی است

**راه‌حل:** فقط عدد خالص وارد کنید (مثال: `12345`)

---

### خطای "Template not found" (کد خطا: `-11`)

**علت:** کد الگوی وارد شده در پنل ملی‌پیامک وجود ندارد یا متعلق به حساب شما نیست

**راه‌حل:** 
1. وارد پنل ملی‌پیامک شوید
2. از لیست الگوها، کد صحیح را کپی کنید
3. مطمئن شوید که الگو تایید شده است

---

### خطای "Variables not sent correctly" (کد خطا: `-12`)

**علت:** تعداد یا ترتیب متغیرهای الگو با آنچه افزونه ارسال می‌کند مطابقت ندارد

**راه‌حل:**
1. الگوی خود را ویرایش کنید
2. مطمئن شوید که **4 متغیر** دارد
3. ترتیب متغیرها: `{1}` شماره سفارش، `{2}` نام مشتری، `{3}` وضعیت، `{4}` تاریخ

---

### خطای "نام کاربری یا رمز عبور اشتباه است" (کد خطا: `-2`)

**علت:** اطلاعات ورود به پنل ملی‌پیامک اشتباه است

**راه‌حل:**
1. نام کاربری و رمز عبور پنل ملی‌پیامک را بررسی کنید
2. معمولاً نام کاربری همان شماره موبایلی است که با آن ثبت‌نام کرده‌اید
3. از دکمه **بررسی اتصال** برای تست استفاده کنید

---

### خطای "اعتبار کافی نیست" (کد خطا: `-6`)

**علت:** موجودی حساب ملی‌پیامک شما کافی نیست

**راه‌حل:**
1. وارد پنل ملی‌پیامک شوید
2. حساب خود را شارژ کنید
3. اعتبار باقیمانده را از طریق دکمه **بررسی اتصال** چک کنید

---

## تست ارسال پیامک

برای اطمینان از صحت تنظیمات:

1. به بخش **تست ارسال پیامک** در تنظیمات بروید
2. **شماره موبایل خود** را وارد کنید (فرمت: `09123456789`)
3. **کد الگوی تست** را وارد کنید (یکی از کدهای بالا)
4. روی **ارسال پیامک تست** کلیک کنید
5. چند لحظه صبر کنید تا پیامک دریافت شود

## پارامترهای ارسال شده به API

افزونه Tabesh پارامترهای زیر را به متد `SendByBaseNumber2` ارسال می‌کند:

```php
// SOAP Parameters
[
    'username' => 'YOUR_USERNAME',      // نام کاربری پنل
    'password' => 'YOUR_PASSWORD',      // رمز عبور پنل
    'text' => [                         // آرایه متغیرها
        'TB-00123',                     // [0] شماره سفارش
        'علی احمدی',                   // [1] نام مشتری
        'در حال چاپ',                  // [2] وضعیت
        '1402/12/15'                    // [3] تاریخ
    ],
    'to' => '09123456789',              // شماره گیرنده
    'bodyId' => 12345                   // کد الگو (عدد صحیح)
]
```

## کدهای خطای API

| کد | توضیح |
|----|-------|
| `-1` | پارامترها ناقص است |
| `-2` | نام کاربری یا رمز عبور اشتباه است |
| `-3` | امکان ارسال روزانه به پایان رسیده |
| `-5` | کاربر مسدود شده است |
| `-6` | اعتبار کافی نیست |
| `-8` | شماره فرستنده معتبر نیست |
| `-9` | شماره گیرنده معتبر نیست |
| `-11` | کد الگو پیدا نشد یا متعلق به شما نیست |
| `-12` | پارامترهای ارسالی با الگو مطابقت ندارد |

> **نکته:** اعداد مثبت نشان‌دهنده موفقیت و شماره پیام ارسال شده هستند.

## پشتیبانی

در صورت مواجهه با مشکل:

1. ابتدا لاگ‌های خطا را بررسی کنید (اگر `WP_DEBUG` فعال است)
2. از دکمه **بررسی اتصال** برای تست اتصال استفاده کنید
3. از بخش **تست ارسال پیامک** برای تست الگو استفاده کنید
4. مستندات API ملی‌پیامک را مطالعه کنید: [github.com/melipayamak](https://github.com/melipayamak)

## نسخه و تاریخ

- **نسخه افزونه:** 1.0.2
- **تاریخ آخرین بروزرسانی:** 1403/09/12
- **API Version:** SOAP (SendByBaseNumber2)
