# راهنمای رفع مشکل چرخه قیمت‌گذاری

## خلاصه مشکل

چرخه قیمت‌گذاری در تابش دارای یک نقص اساسی بود که باعث شکست فرایند از ثبت قیمت تا ثبت سفارش می‌شد.

### علت اصلی

**عدم همخوانی بین پارامترهای محصول و ماتریس‌های قیمت‌گذاری** باعث می‌شد:

1. **فرم ثبت قیمت** (`[tabesh_product_pricing]`):
   - قطع‌هایی را در dropdown نشان می‌داد که در پارامترهای محصول نبودند
   - اما هنگام ذخیره، آن‌ها را رد می‌کرد (validation failure)
   - در نتیجه ماتریس‌های قیمت "یتیم" (orphaned) ایجاد می‌شدند

2. **فرم سفارش V2** (`[tabesh_order_form_v2]`):
   - نمی‌توانست قطع‌ها را فراخوانی کند
   - خطای "هیچ قطع کتابی پیکربندی نشده" نمایش می‌داد
   - چرخه شکسته می‌شد

## راه‌حل پیاده‌سازی شده

### 1. اصلاح منبع اصلی داده (Source of Truth)

**قبل از تغییر:**
```php
private function get_all_book_sizes() {
    $configured_sizes = $this->pricing_engine->get_configured_book_sizes(); // از ماتریس‌ها
    $admin_sizes = $this->get_valid_book_sizes_from_settings(); // از تنظیمات
    
    // مشکل: ترکیب هر دو منبع
    $all_sizes = array_merge($configured_sizes, $admin_sizes);
    return $all_sizes;
}
```

**بعد از تغییر:**
```php
private function get_all_book_sizes() {
    // فقط از پارامترهای محصول (منبع اصلی)
    $admin_sizes = $this->get_valid_book_sizes_from_settings();
    return $admin_sizes;
}
```

### 2. افزودن پاکسازی خودکار

متد جدید `cleanup_orphaned_pricing_matrices()`:
- هنگام بارگذاری فرم قیمت‌گذاری اجرا می‌شود
- ماتریس‌های یتیم (برای قطع‌های غیرمعتبر) را حذف می‌کند
- از bulk delete برای کارایی استفاده می‌کند
- cache را پس از پاکسازی پاک می‌کند

### 3. بهبود مدیریت خطا

**افزودن logging کامل:**
```php
error_log(sprintf(
    'Tabesh: Size "%s" is available - %d papers, %d bindings',
    $size,
    count($papers),
    count($bindings)
));
```

**بهبود پیام‌های خطا در فرم سفارش:**
- راهنمای قدم‌به‌قدم برای مدیر
- لینک مستقیم به صفحات مربوطه
- توضیح دقیق مشکل و راه‌حل

### 4. ابزار تشخیص مشکل

فایل `diagnostic-pricing-cycle.php` برای تشخیص و رفع مشکلات:

**نحوه استفاده:**
1. فایل را در پوشه plugin قرار دهید
2. به `/wp-content/plugins/Tabesh/diagnostic-pricing-cycle.php` بروید
3. وضعیت کل چرخه را مشاهده کنید
4. توصیه‌های رفع مشکل را دنبال کنید

**اطلاعاتی که نمایش می‌دهد:**
- ✅ قطع‌های کتاب در پارامترهای محصول
- ✅ ماتریس‌های قیمت ذخیره شده
- ✅ وضعیت موتور قیمت‌گذاری
- ✅ قطع‌های قابل دسترس از Constraint Manager
- ✅ تحلیل همخوانی داده‌ها
- ✅ توصیه‌های رفع مشکل

## دستورالعمل نصب و راه‌اندازی

### مرحله 1: فعال‌سازی موتور قیمت‌گذاری V2

1. به **مدیریت قیمت‌گذاری محصولات** بروید
2. روی **فعال‌سازی موتور جدید** کلیک کنید
3. منتظر بمانید تا تایید موفقیت نمایش داده شود

### مرحله 2: تنظیم قطع‌های کتاب

1. به **تنظیمات محصول** (Settings) بروید
2. قسمت **قطع‌های کتاب** را پیدا کنید
3. قطع‌های مورد نظر را اضافه کنید (مثلاً: A5، A4، رقعی، وزیری)
4. ذخیره کنید

**مهم:** این منبع اصلی (source of truth) است. فقط قطع‌هایی که اینجا تعریف شده‌اند، قابل قیمت‌گذاری هستند.

### مرحله 3: تنظیم قیمت برای هر قطع

1. به **مدیریت قیمت‌گذاری محصولات** بروید
2. قطع مورد نظر را انتخاب کنید
3. قیمت‌ها را تنظیم کنید:
   - هزینه هر صفحه (کاغذ + چاپ)
   - هزینه صحافی و جلد
   - خدمات اضافی
   - حاشیه سود
   - محدودیت‌های تیراژ
4. ذخیره کنید

**نکته:** برای هر قطع در تنظیمات محصول باید یک ماتریس قیمت تنظیم کنید.

### مرحله 4: تست فرم سفارش

1. یک صفحه جدید بسازید
2. شورتکد `[tabesh_order_form_v2]` را اضافه کنید
3. صفحه را مشاهده کنید
4. باید قطع‌های تنظیم شده را ببینید

## عیب‌یابی

### مشکل: "هیچ قطع کتابی پیکربندی نشده است"

**راه‌حل‌های احتمالی:**

1. **بررسی پارامترهای محصول:**
   ```
   تنظیمات > قطع‌های کتاب
   آیا قطعی تعریف شده است؟
   ```

2. **بررسی موتور قیمت‌گذاری:**
   ```
   مدیریت قیمت‌گذاری > وضعیت موتور
   آیا V2 فعال است؟
   ```

3. **بررسی ماتریس‌های قیمت:**
   ```
   برای هر قطع در تنظیمات محصول،
   آیا ماتریس قیمت تنظیم شده است؟
   ```

4. **اجرای تشخیص خودکار:**
   ```
   به diagnostic-pricing-cycle.php بروید
   توصیه‌های سیستم را دنبال کنید
   ```

### مشکل: قطعی نشان داده نمی‌شود

**علل احتمالی:**
- قطع در تنظیمات محصول نیست → اضافه کنید
- ماتریس قیمت برای قطع وجود ندارد → تنظیم کنید
- ماتریس قیمت خراب است → با پاکسازی خودکار حذف می‌شود

**راه‌حل:**
1. به فرم قیمت‌گذاری بروید (پاکسازی خودکار اجرا می‌شود)
2. قطع را از dropdown انتخاب کنید
3. اگر قطع در dropdown نیست، به تنظیمات محصول بروید و اضافه کنید
4. قیمت‌ها را تنظیم و ذخیره کنید

### مشکل: ماتریس‌های یتیم (Orphaned Matrices)

**علائم:**
- قطعی در dropdown فرم قیمت نشان داده می‌شود
- اما هنگام ذخیره خطا می‌دهد
- یا در فرم سفارش ظاهر نمی‌شود

**راه‌حل خودکار:**
- فرم قیمت‌گذاری را بارگذاری کنید
- سیستم به صورت خودکار ماتریس‌های یتیم را پاک می‌کند
- log‌ها را بررسی کنید (اگر WP_DEBUG فعال است)

## نکات امنیتی

### داده‌های حساس

این رفع باگ شامل موارد امنیتی زیر است:

✅ **Sanitization**: تمام ورودی‌های کاربر sanitize می‌شوند
✅ **Escaping**: تمام خروجی‌ها escape می‌شوند  
✅ **Nonce Verification**: تمام فرم‌ها nonce دارند
✅ **Prepared Statements**: تمام query‌ها از `$wpdb->prepare()` استفاده می‌کنند
✅ **Validation**: تنها قطع‌های معتبر قابل ذخیره هستند

### Logging

لاگ‌های debug تنها زمانی فعال هستند که `WP_DEBUG` برقرار باشد:

```php
if (defined('WP_DEBUG') && WP_DEBUG) {
    error_log('Tabesh: Debug message');
}
```

**هشدار:** `WP_DEBUG` را در محیط production خاموش کنید.

## تفاوت قبل و بعد

### قبل از رفع باگ ❌

```
مدیر → فرم قیمت → ذخیره قیمت برای قطع X
         ↓
    (قطع X در تنظیمات محصول نیست)
         ↓
    خطا: قطع نامعتبر
         ↓
    ماتریس یتیم در دیتابیس
         ↓
    فرم سفارش نمی‌تواند قطع را پیدا کند
         ↓
    چرخه شکسته ❌
```

### بعد از رفع باگ ✅

```
مدیر → فرم قیمت → (پاکسازی خودکار ماتریس‌های یتیم)
         ↓
    فقط قطع‌های تنظیمات محصول نشان داده می‌شوند
         ↓
    ذخیره قیمت برای قطع X
         ↓
    validation: قطع X در تنظیمات محصول است ✓
         ↓
    ماتریس قیمت ذخیره می‌شود
         ↓
    فرم سفارش قطع X را نشان می‌دهد
         ↓
    مشتری می‌تواند سفارش دهد
         ↓
    چرخه کامل ✅
```

## سوالات متداول

### چگونه بفهمم چرخه درست کار می‌کند؟

1. به `diagnostic-pricing-cycle.php` بروید
2. اگر پیام **"همه چیز درست کار می‌کند"** را دیدید، همه چیز OK است
3. تعداد قطع‌های فعال را بررسی کنید

### آیا داده‌های قبلی حذف می‌شوند؟

**خیر.** تنها ماتریس‌های یتیم (برای قطع‌های غیرمعتبر) حذف می‌شوند.
ماتریس‌های معتبر (برای قطع‌های موجود در تنظیمات) حفظ می‌شوند.

### آیا نیاز به backup دارم؟

**بله، همیشه!** قبل از هر تغییری backup بگیرید:
```bash
# Backup database
mysqldump -u username -p database_name > backup.sql

# Backup files
zip -r tabesh-backup.zip wp-content/plugins/Tabesh/
```

### چطور ماتریس‌های یتیم را شناسایی کنم؟

از ابزار diagnostic استفاده کنید:
```
diagnostic-pricing-cycle.php
↓
بخش "قطع‌های خراب/غیرمجاز"
```

### آیا این fix روی سفارشات قبلی تأثیر دارد؟

**خیر.** سفارشات ثبت شده تغییری نمی‌کنند.
فقط روی فرایند ثبت سفارش جدید تأثیر دارد.

## پشتیبانی

در صورت بروز مشکل:

1. **فعال کردن WP_DEBUG:**
   ```php
   // wp-config.php
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   define('WP_DEBUG_DISPLAY', false);
   ```

2. **بررسی log‌ها:**
   ```
   wp-content/debug.log
   ```

3. **اجرای diagnostic:**
   ```
   diagnostic-pricing-cycle.php
   ```

4. **ارسال اطلاعات:**
   - لاگ‌های debug
   - خروجی diagnostic
   - اسکرین‌شات خطا

## مدیریت ماتریس‌های یتیم در آینده

سیستم به صورت خودکار از ایجاد ماتریس‌های یتیم جلوگیری می‌کند:

1. **Validation قوی‌تر:** فقط قطع‌های معتبر قابل ذخیره هستند
2. **پاکسازی خودکار:** ماتریس‌های یتیم در بارگذاری فرم پاک می‌شوند
3. **Source of truth واحد:** فقط از تنظیمات محصول استفاده می‌شود

## نتیجه‌گیری

این fix چرخه قیمت‌گذاری را کاملاً ترمیم می‌کند و از مشکلات آینده جلوگیری می‌کند.

**قبل:**
- ماتریس‌های یتیم
- عدم همخوانی داده‌ها
- فرم سفارش خراب
- چرخه شکسته

**بعد:**
- یک منبع داده (source of truth)
- پاکسازی خودکار
- خطاهای واضح
- چرخه کامل و کارآمد

✅ **چرخه قیمت‌گذاری حالا کاملاً کاربردی است!**
