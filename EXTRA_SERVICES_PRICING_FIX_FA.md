# گزارش نهایی: رفع مشکل محاسبه مضاعف قیمت خدمات اضافی

## خلاصه مشکل

در محاسبه قیمت خدمات اضافی (Extra Services) با نوع محاسبه متغیر (پویا)، منطق قبلی باعث اعمال فرمول اشتباه و محاسبه مضاعف می‌شد که قیمت‌های نهایی را بسیار بالا نشان می‌داد.

### مثال عملی مشکل
**سرویس**: قیمت ۲,۰۰۰ تومان برای هر جلد  
**تیراژ**: ۱۰ جلد

- **محاسبه صحیح مورد انتظار**: `۲,۰۰۰ × ۱۰ = ۲۰,۰۰۰ تومان`
- **محاسبه غلط قبلی**: `(۲,۰۰۰ × ۱۰) × ۱۰ = ۲۰۰,۰۰۰ تومان`

این مشکل دو نوع قیمت‌گذاری را تحت تأثیر قرار می‌داد:
1. **بر اساس هر جلد (Per-Unit)**: هزینه به ازای هر جلد/نسخه
2. **بر اساس صفحه (Page-Based)**: هزینه بر اساس مجموع کل صفحات

## علت اصلی مشکل

باگ در فایل `/includes/handlers/class-tabesh-order.php` در متد `calculate_price()` بود.

**منطق قبلی (اشتباه)**:
```php
// مرحله ۱: محاسبه هزینه اضافی (قبلاً در تیراژ ضرب شده)
case 'per_unit':
    $extra_cost = $option_price * $quantity; // مثال: ۲۰۰۰ × ۱۰ = ۲۰,۰۰۰

// مرحله ۲: اضافه شدن به هزینه آپشن‌ها
$options_cost += $extra_cost; // ۲۰,۰۰۰

// مرحله ۳: اضافه شدن به هزینه تولید هر کتاب
$production_cost_per_book = ... + $options_cost;
// = ... + ۲۰,۰۰۰

// مرحله ۴: ضرب مجدد در تیراژ (باگ!)
$subtotal = $production_cost_per_book * $quantity;
// = (... + ۲۰,۰۰۰) × ۱۰ = ... + ۲۰۰,۰۰۰
```

مشکل این بود که آپشن‌های per-unit و page-based:
1. ابتدا در تیراژ/صفحات ضرب می‌شدند
2. سپس به `$production_cost_per_book` اضافه می‌شدند
3. سپس کل `$production_cost_per_book` دوباره در تیراژ ضرب می‌شد

این منجر به **ضرب مضاعف** می‌شد.

## راه‌حل پیاده‌سازی شده

منطق محاسبه قیمت را بازنویسی کردیم تا دو دسته آپشن را جدا کنیم:
1. **آپشن‌های ثابت (Fixed)**: هزینه‌های یکباره که به هزینه هر کتاب اضافه می‌شوند (سپس در تیراژ ضرب می‌شوند)
2. **آپشن‌های متغیر (Variable)**: هزینه‌هایی که قبلاً تیراژ/صفحات را در نظر گرفته‌اند (بعد از ضرب تیراژ اضافه می‌شوند)

### منطق جدید (اصلاح شده)
```php
// جداسازی آپشن‌های ثابت و متغیر
$fixed_options_cost = 0;    // در تیراژ ضرب خواهد شد
$variable_options_cost = 0; // قبلاً تیراژ را در نظر گرفته

switch ($option_type) {
    case 'fixed':
        $extra_cost = $option_price;
        $fixed_options_cost += $extra_cost;  // به هزینه هر کتاب اضافه می‌شود
        break;
        
    case 'per_unit':
        $extra_cost = $option_price * $quantity; // یکبار محاسبه
        $variable_options_cost += $extra_cost;   // به هزینه هر کتاب اضافه نمی‌شود
        break;
        
    case 'page_based':
        $total_pages = $page_count_total * $quantity;
        $units = ceil($total_pages / $option_step);
        $extra_cost = $option_price * $units;    // یکبار محاسبه
        $variable_options_cost += $extra_cost;   // به هزینه هر کتاب اضافه نمی‌شود
        break;
}

// آپشن‌های ثابت در هزینه هر کتاب لحاظ می‌شوند (در تیراژ ضرب می‌شوند)
$production_cost_per_book = ... + $fixed_options_cost;

// آپشن‌های متغیر بعد از ضرب تیراژ اضافه می‌شوند (دوباره ضرب نمی‌شوند)
$subtotal_before_variable = $production_cost_per_book * $quantity;
$subtotal = $subtotal_before_variable + $variable_options_cost;
```

## فرمول‌های سه نوع قیمت‌گذاری

طبق بیان مسئله، سه نوع قیمت‌گذاری اکنون بدرستی پیاده‌سازی شده‌اند:

| نوع قیمت‌گذاری | متغیر کلیدی | فرمول محاسبه |
|----------------|-------------|--------------|
| **ثابت (Fixed)** | ندارد | `قیمت_ثابت` |
| **بر اساس جلد (Per-Unit)** | تیراژ (V) | `هزینه سرویس = قیمت_واحد × تیراژ` |
| **بر اساس صفحه (Page-Based)** | مجموع صفحات | `هزینه سرویس = قیمت_صفحه × مجموع_صفحات` |

## تغییرات اعمال شده

### فایل: `/includes/handlers/class-tabesh-order.php`

1. **تقسیم محاسبه هزینه آپشن‌ها** (خطوط ۲۰۴-۳۴۵):
   - معرفی `$fixed_options_cost` برای آپشن‌های نوع ثابت
   - معرفی `$variable_options_cost` برای آپشن‌های per-unit و page-based
   - بروزرسانی switch case ها برای افزودن هزینه‌ها به متغیر مناسب

2. **بروزرسانی محاسبه هزینه هر کتاب** (خط ۳۵۱):
   - فقط شامل آپشن‌های ثابت: `$production_cost_per_book = ... + $fixed_options_cost`
   
3. **بروزرسانی محاسبه جمع کل** (خطوط ۳۵۵-۳۵۶):
   - ابتدا هزینه هر کتاب در تیراژ ضرب می‌شود
   - سپس آپشن‌های متغیر اضافه می‌شوند (که قبلاً تیراژ/صفحات را در نظر گرفته‌اند)

4. **بهبود خروجی breakdown** (خطوط ۴۱۱-۴۳۰):
   - افزودن `fixed_options_cost` به breakdown
   - افزودن `variable_options_cost` به breakdown
   - حفظ `options_cost` برای سازگاری با نسخه‌های قبل

5. **افزودن مستندات جامع** (خطوط ۲۰۴-۲۱۲):
   - توضیح هر سه نوع قیمت‌گذاری
   - مستندسازی فرمول‌ها
   - توضیح دلیل جداسازی هزینه‌های ثابت و متغیر

## تست‌ها

ایجاد مجموعه تست جامع (`/tmp/test-pricing-calculation.php`) که موارد زیر را بررسی می‌کند:

### نتایج تست‌ها

| تست | سرویس | قبلی (اشتباه) | جدید (صحیح) | وضعیت |
|-----|--------|---------------|-------------|--------|
| **Per-Unit** | ۲,۰۰۰ تومان/جلد × ۱۰ | ۲۰۰,۰۰۰ | ۲۰,۰۰۰ | ✓ قبول |
| **سرویس واقعی** | لب گرد (۱,۰۰۰/جلد × ۱۰) | ۱۰۰,۰۰۰ | ۱۰,۰۰۰ | ✓ قبول |
| **Page-Based** | بسته‌بندی کارتن | ۵۰۰,۰۰۰ | ۵۰,۰۰۰ | ✓ قبول |
| **ثابت** | UV کوتینگ (۳,۰۰۰ ثابت) | ۳۰,۰۰۰ | ۳۰,۰۰۰ | ✓ قبول |

همه تست‌ها قبول شدند و تأیید می‌کنند:
- سرویس‌های per-unit دیگر ضرب مضاعف ندارند
- سرویس‌های page-based دیگر ضرب مضاعف ندارند
- سرویس‌های ثابت همچنان صحیح کار می‌کنند (بدون رگرسیون)

## تأثیر

### قبل از اصلاح (رفتار قدیمی)
- **سرویس per-unit** با قیمت ۲,۰۰۰ تومان/جلد برای ۱۰ جلد: **۲۰۰,۰۰۰ تومان** ❌
- **سرویس page-based** برای ۲,۰۰۰ صفحه: **۵۰۰,۰۰۰ تومان** ❌
- قیمت‌ها برای تیراژ ۱۰ جلد، ۱۰ برابر بیشتر نشان داده می‌شدند

### بعد از اصلاح (رفتار جدید)
- **سرویس per-unit** با قیمت ۲,۰۰۰ تومان/جلد برای ۱۰ جلد: **۲۰,۰۰۰ تومان** ✓
- **سرویس page-based** برای ۲,۰۰۰ صفحه: **۵۰,۰۰۰ تومان** ✓
- قیمت‌ها اکنون صحیح محاسبه می‌شوند

## سازگاری با نسخه‌های قبل

این اصلاح سازگاری با نسخه‌های قبل را حفظ می‌کند:
- ساختار مقدار بازگشتی بدون تغییر
- `options_cost` همچنان برگردانده می‌شود (مجموع ثابت + متغیر)
- فیلدهای جدید (`fixed_options_cost`, `variable_options_cost`) برای شفافیت اضافه شده‌اند
- بدون تغییرات ناسازگار در API

## امنیت

- هیچ آسیب‌پذیری امنیتی جدیدی معرفی نشده
- تمام پاکسازی و اعتبارسنجی موجود حفظ شده
- بدون تغییر در منطق احراز هویت یا مجوزدهی

## کیفیت کد

- استانداردهای کدنویسی وردپرس از طریق `composer phpcbf` اعمال شده
- تمام خطاهای لینت قابل اصلاح خودکار تصحیح شده
- مستندات درون‌خطی جامع اضافه شده
- نام‌گذاری متغیرها واضح برای نگهداری آسان

## فایل‌های مرتبط

### تغییر یافته
- `/includes/handlers/class-tabesh-order.php` - منطق اصلی محاسبه قیمت

### فایل‌های تست (کامیت نشده)
- `/tmp/test-pricing-calculation.php` - مجموعه تست مستقل

## تاریخچه کامیت‌ها

1. **طرح اولیه**: تحلیل و برنامه‌ریزی
2. **Fix(PHP)**: اصلاح محاسبه قیمت متغیر خدمات اضافی برای جلوگیری از ضرب مضاعف
3. **Docs**: افزودن مستندات جامع برای اصلاح قیمت‌گذاری خدمات اضافی

## مراحل بعدی

این اصلاح باید قبل از استقرار در محیط تولید، در محیط staging با فرم‌های سفارش واقعی که از شورتکد `[tabesh_order_form]` استفاده می‌کنند، تست دستی شود.

### تست‌های دستی پیشنهادی

1. **تست قیمت ثابت**:
   - یک سرویس اضافی با قیمت ثابت انتخاب کنید
   - بررسی کنید قیمت با تغییر تیراژ تغییر نکند

2. **تست Per-Unit**:
   - سرویس لب گرد (۱,۰۰۰ تومان/جلد) انتخاب کنید
   - تیراژ را روی ۱۰ تنظیم کنید
   - مورد انتظار: ۱۰,۰۰۰ تومان به مجموع اضافه شود

3. **تست Page-Based**:
   - سرویس بسته‌بندی کارتن انتخاب کنید
   - ۲۰۰ صفحه × ۱۰ جلد تنظیم کنید
   - مورد انتظار: ۵۰,۰۰۰ تومان به مجموع اضافه شود

4. **تست ترکیبی**:
   - چند سرویس اضافی از انواع مختلف انتخاب کنید
   - بررسی کنید مجموع برابر با جمع محاسبات جداگانه است

## منابع

- بیان مسئله: ایشو توضیح‌دهنده باگ ضرب مضاعف
- WordPress Codex: [استانداردهای کدنویسی](https://developer.wordpress.org/coding-standards/)
- مستندات تابش: `PRICING_TROUBLESHOOTING.md` و `API.md` را ببینید
